<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contenta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: #020617;
      color: #e5e7eb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      padding: 1.5rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 0.3rem;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      opacity: 0.8;
      margin-bottom: 1rem;
    }

    .description {
      text-align: center;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      opacity: 0.9;
    }

    .media-type-selector {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .media-type-selector select {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #1e293b;
      background: #0f172a;
      color: #e5e7eb;
      margin-right: 0.5rem;
    }

    .media-type-selector button {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: none;
      background: #1e293b;
      color: #e5e7eb;
      cursor: pointer;
    }

    .media-type-selector button:hover {
      background: #334155;
    }

    .grid-container {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      max-width: 1200px;
      margin: auto;
    }

    .grid-section {
      flex: 1;
      min-width: 300px;
    }

    .grid-section h2 {
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #38bdf8;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1rem;
    }

    .card {
      background: linear-gradient(135deg, #0f172a, #020617);
      border: 1px solid #1e293b;
      border-radius: 14px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      transition: transform 0.15s ease;
    }

    .card:hover {
      transform: scale(1.02);
    }

    .title {
      font-size: 0.9rem;
      font-weight: 600;
      word-break: break-all;
      color: #38bdf8;
    }

    .meta {
      font-size: 0.75rem;
      color: #94a3b8;
      line-height: 1.4;
    }

    .open-btn {
      margin-top: auto;
      padding: 0.6rem;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background: #1e293b;
      color: #e5e7eb;
      font-weight: 500;
    }

    .open-btn:hover {
      background: #334155;
    }

    .status {
      text-align: center;
      opacity: 0.85;
      margin-top: 2rem;
      font-size: 0.9rem;
    }

    .back {
      display: block;
      text-align: center;
      margin-bottom: 1rem;
      color: #93c5fd;
      text-decoration: none;
      font-size: 0.9rem;
    }
    
    .reviews-link {
      color: #60a5fa;
      text-decoration: none;
    }
    
    .reviews-link:hover {
      text-decoration: underline;
    }

    /* Fullscreen overlay styles */
    .fullscreen-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .close-btn {
      position: fixed;
      top: 15px;
      right: 15px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      font-size: 16px;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .embed-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .embed-container iframe {
      width: 100vw;
      height: 100vh;
      border: none;
    }
    
    .share-btn {
      background: none;
      border: none;
      color: #60a5fa;
      cursor: pointer;
      font-size: 1.2rem;
      padding: 0;
      margin-left: 0.5rem;
    }
    
    .share-btn:hover {
      color: #93c5fd;
    }
    
    .profile-link {
      color: #60a5fa;
      text-decoration: none;
      margin-left: 5px;
      cursor: pointer;
    }
    
    .profile-link:hover {
      text-decoration: underline;
    }
    
    .preview-container {
      height: 150px;
      margin: 5px 0;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .preview-placeholder {
      height: 100%;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
      font-size: 0.8rem;
    }
    
    .preview-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    .card-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: auto;
      align-items: center;
    }
    
    .username-meta {
      font-size: 0.75rem;
      color: #93c5fd;
      line-height: 1.4;
    }
    
    .description-full {
      font-size: 0.75rem;
      color: #cbd5e1;
      line-height: 1.5;
      margin-top: 0.5rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .files-info {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.8rem;
      color: #93c5fd;
      margin-top: 0.3rem;
    }
    
    .files-symbol {
      cursor: pointer;
      background: none;
      border: none;
      color: #93c5fd;
      font-size: 1rem;
    }
    
    .files-symbol:hover {
      color: #60a5fa;
    }
  </style>
</head>
<body>

  <a class="back" href="index.html">‚Üê Back to Dashboard</a>
  <h1>
    <span>üìö</span> Contenta
  </h1>
  <div class="description">A place to learn, enjoy, feel, express‚Äîwhile knowing others and being active together.</div>
  
  <div class="media-type-selector">
    <label for="mediatype">Media Type:</label>
    <select id="mediatype">
      <option value="all">All Types</option>
      <option value="texts">Texts</option>
      <option value="movies">Movies</option>
      <option value="audio">Audio</option>
      <option value="software">Software</option>
      <option value="image">Images</option>
      <option value="data">Data</option>
      <option value="web">Web</option>
      <option value="collection">Collections</option>
      <option value="account">Accounts</option>
    </select>
    <button id="filter-btn">OK</button>
  </div>

  <div class="subtitle" id="subtitle"></div>

  <div class="grid-container">
    <div class="grid-section">
      <h2>Profile Items</h2>
      <div class="grid" id="grid"></div>
    </div>
    <div class="grid-section">
      <h2>Identifiers</h2>
      <div class="grid" id="identifiers-grid"></div>
    </div>
  </div>

  <div class="status" id="status">Initializing‚Ä¶</div>

  <script>
    const grid = document.getElementById("grid");
    const identifiersGrid = document.getElementById("identifiers-grid");
    const status = document.getElementById("status");
    const subtitle = document.getElementById("subtitle");
    const mediatypeSelect = document.getElementById("mediatype");
    const filterBtn = document.getElementById("filter-btn");

    // Store all items for filtering
    let allItems = [];
    let currentFilter = "all";

    // Embed configuration function
    function getEmbedConfig(identifier, mediatype) {
      switch (mediatype) {
        case "movies":
        case "image":
          return {
            type: "iframe",
            url: `https://archive.org/embed/${identifier}`
          };

        case "audio":
          return {
            type: "iframe",
            url: `https://archive.org/details/${identifier}`
          };

        case "texts":
          return {
            type: "text",
            url: null
          };

        default:
          return null;
      }
    }

    // Helper to detect PDF files
    async function getPdfFile(identifier) {
      try {
        const res = await fetch(`https://archive.org/metadata/${identifier}`);
        const data = await res.json();
        const files = data.files || [];

        const pdf = files.find(f =>
          f.name.toLowerCase().endsWith(".pdf") &&
          f.source === "original"
        );

        return pdf ? pdf.name : null;
      } catch {
        return null;
      }
    }

    // IntersectionObserver for lazy loading previews
    const previewObserver = new IntersectionObserver(entries => {
      entries.forEach(async entry => {
        if (!entry.isIntersecting) return;

        const container = entry.target;
        const identifier = container.dataset.identifier;
        const mediaType = container.dataset.mediatype;

        // TEXTS ‚Üí try PDF
        if (mediaType === "texts") {
          const pdfFile = await getPdfFile(identifier);

          if (pdfFile) {
            const pdfUrl = `https://archive.org/download/${identifier}/${encodeURIComponent(pdfFile)}`;
            const viewer = `https://docs.google.com/gview?url=${encodeURIComponent(pdfUrl)}&embedded=true`;

            container.innerHTML = `<iframe src="${viewer}" loading="lazy"></iframe>`;
          } else {
            container.innerHTML = `<div class="preview-placeholder">No PDF preview</div>`;
          }

          previewObserver.unobserve(container);
          return;
        }

        // Other media
        const embed = getEmbedConfig(identifier, mediaType);

        if (!embed || !embed.url) {
          container.innerHTML = `<div class="preview-placeholder">No inline preview</div>`;
          previewObserver.unobserve(container);
          return;
        }

        container.innerHTML =
          `<iframe src="${embed.url}" loading="lazy" allowfullscreen></iframe>`;

        previewObserver.unobserve(container);
      });
    }, {
      rootMargin: "200px",
      threshold: 0.1
    });

    const stored = localStorage.getItem("archive_profile_urls");
    if (!stored) {
      status.textContent = "No archive data found.";
      throw new Error("Missing localStorage");
    }

    let profileUrls = JSON.parse(stored);
    if (!profileUrls.length) {
      status.textContent = "Archive list is empty.";
      throw new Error("Empty list");
    }

    // üé≤ Shuffle profiles (random order, no repeats)
    profileUrls = profileUrls
      .map(v => ({ v, r: Math.random() }))
      .sort((a, b) => a.r - b.r)
      .map(o => o.v);

    function extractUsername(url) {
      const match = url.match(/@([^/]+)/);
      return match ? match[1] : null;
    }

    // Account state tracking
    let accountState = {};
    let usedThisRound = new Set();
    // Store username mapping
    let usernameMap = {};

    profileUrls.forEach(url => {
      const username = extractUsername(url);
      if (username) {
        usernameMap[url] = username;
      }
      accountState[url] = {
        page: 1,
        total: null,
        exhausted: false
      };
    });

    function pickRandomAccount() {
      const available = profileUrls.filter(
        u => !usedThisRound.has(u) && !accountState[u].exhausted
      );

      if (!available.length) {
        usedThisRound.clear(); // start next round
        return pickRandomAccount();
      }

      const pick = available[Math.floor(Math.random() * available.length)];
      usedThisRound.add(pick);
      return pick;
    }

    async function fetchThreeLatest(profileUrl) {
      const username = usernameMap[profileUrl];
      const state = accountState[profileUrl];
      if (state.exhausted) return null;

      const api =
        `https://archive.org/advancedsearch.php` +
        `?q=creator:@${username}` +
        `&fl[]=identifier` +
        `&fl[]=title` +
        `&fl[]=creator` +
        `&fl[]=publicdate` +
        `&fl[]=mediatype` +
        `&fl[]=description` +
        `&fl[]=subject` +
        `&fl[]=gmail` +
        `&fl[]=link1` +
        `&fl[]=link2` +
        `&fl[]=link3` +
        `&fl[]=phone_number` +
        `&sort[]=publicdate desc` +
        `&rows=3` +
        `&page=${state.page}` +
        `&output=json`;

      const res = await fetch(api);
      const data = await res.json();

      if (state.total === null) {
        state.total = data.response.numFound;
      }

      if (!data.response.docs.length) {
        state.exhausted = true;
        return null;
      }

      state.page++;
      // Return both docs and the username
      return {
        docs: data.response.docs,
        username: username
      };
    }

    // Get original files count for an item
    async function getOriginalFilesCount(identifier) {
      try {
        const res = await fetch(`https://archive.org/metadata/${identifier}`);
        const data = await res.json();
        const files = data.files || [];
        
        // Count original files (excluding derivatives and system files)
        const originalFiles = files.filter(file =>
          file.source === "original" &&
          !file.name.startsWith(".") &&
          !file.name.toLowerCase().includes("_thumb") &&
          !file.name.toLowerCase().includes("_preview") &&
          !file.name.toLowerCase().includes("_spectrogram") &&
          !file.name.toLowerCase().includes("_meta") &&
          !file.name.toLowerCase().includes("_rules") &&
          !file.name.match(/\.(torrent|sqlite|xml|jsonl|log|conf|md5|sha1|sha256)$/i)
        );
        
        return originalFiles.length;
      } catch (err) {
        console.error(`Error fetching metadata for ${identifier}:`, err);
        return 0;
      }
    }

    // Fetch metadata using Archive.org metadata API
    async function fetchIdentifierMetadata(identifier) {
      try {
        const response = await fetch(`https://archive.org/metadata/${identifier}`);
        const data = await response.json();
        
        if (data.metadata) {
          // Use metadata from the metadata API response
          return {
            identifier: identifier,
            title: data.metadata.title || identifier,
            creator: data.metadata.creator || "Unknown",
            publicdate: data.metadata.publicdate || "N/A",
            mediatype: data.metadata.mediatype || "unknown",
            description: data.metadata.description || "No description",
            subject: data.metadata.subject || [],
            gmail: data.metadata.gmail,
            link1: data.metadata.link1,
            link2: data.metadata.link2,
            link3: data.metadata.link3,
            phone_number: data.metadata.phone_number
          };
        }
      } catch (error) {
        console.error(`Error fetching metadata for ${identifier}:`, error);
      }
      
      // Fallback: return basic metadata
      return {
        identifier: identifier,
        title: identifier,
        creator: "Unknown",
        publicdate: "N/A",
        mediatype: "unknown",
        description: "No description available",
        subject: []
      };
    }

    function createCard(identifier, metadata, username = null) {
      const title = metadata.title || identifier;
      const creator = metadata.creator || "Unknown";
      const date = metadata.publicdate || "N/A";
      const tags = metadata.subject ? (Array.isArray(metadata.subject) ? metadata.subject.join(", ") : metadata.subject.toString()).slice(0, 100) : "None";
      const mediaType = metadata.mediatype || "unknown";
      const description = metadata.description ? metadata.description.toString() : "No description";
      const gmail = metadata.gmail;
      const link1 = metadata.link1;
      const link2 = metadata.link2;
      const link3 = metadata.link3;
      const phone_number = metadata.phone_number;
      const reviewUrl = `https://archive.org/details/${identifier}#reviews`;
      
      // Modified: Add username=yanshun081 as the last parameter for identifiers
      const shareUrl = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/archive-identifier-page-shared-links-redirecting.html?identifier=${identifier}` + 
        (username ? `&username=${username}` : `&username=yanshun081`);

      const card = document.createElement("div");
      card.className = "card";
      card.dataset.mediatype = mediaType;

      let metaHtml = `
        <div class="title">${title}</div>
        <div class="preview-container"
             data-identifier="${identifier}"
             data-mediatype="${mediaType}">
          <div class="preview-placeholder">Loading preview‚Ä¶</div>
        </div>
        <div class="meta"><b>Creator:</b> ${creator}</div>
      `;

      // Only show username if provided (for profile items)
      if (username) {
        metaHtml += `<div class="username-meta"><b>Username:</b> @${username}</div>`;
      }

      metaHtml += `
        <div class="meta"><b>Date:</b> ${date}</div>
        <div class="meta"><b>Tags:</b> ${tags}</div>
        <div class="meta"><b>Media:</b> ${mediaType}</div>
      `;

      // Add optional fields only if they exist
      if (gmail) metaHtml += `<div class="meta"><b>Gmail:</b> ${gmail}</div>`;
      if (link1) metaHtml += `<div class="meta"><b>Link 1:</b> <a href="${link1}" target="_blank">${link1}</a></div>`;
      if (link2) metaHtml += `<div class="meta"><b>Link 2:</b> <a href="${link2}" target="_blank">${link2}</a></div>`;
      if (link3) metaHtml += `<div class="meta"><b>Link 3:</b> <a href="${link3}" target="_blank">${link3}</a></div>`;
      if (phone_number) metaHtml += `<div class="meta"><b>Phone:</b> ${phone_number}</div>`;

      metaHtml += `
        <div class="description-full">${description}</div>
        <div class="meta">
          <a href="${reviewUrl}" target="_blank" class="reviews-link">Reviews</a>
        </div>
        <div class="card-actions">
          <button class="open-btn">Open Item</button>
          <button class="share-btn" data-share-url="${shareUrl}">·Øì‚û§</button>
        </div>
      `;

      card.innerHTML = metaHtml;

      card.querySelector(".open-btn").onclick = async () => {
        const embed = getEmbedConfig(identifier, mediaType);

        if (mediaType === "texts") {
          const pdf = await getPdfFile(identifier);
          if (pdf) {
            openFullscreen(
              `https://docs.google.com/gview?url=${encodeURIComponent(
                `https://archive.org/download/${identifier}/${pdf}`
              )}&embedded=true`
            );
            return;
          }
        }

        if (embed && embed.url) {
          openFullscreen(embed.url);
        } else {
          window.open(`https://archive.org/details/${identifier}`, "_blank");
        }
      };

      card.querySelector(".share-btn").onclick = (e) => {
        const shareUrl = e.target.dataset.shareUrl;
        // Check if Web Share API is available
        if (navigator.share) {
          navigator.share({
            title: title,
            url: shareUrl
          }).catch(console.error);
        } else {
          // Fallback to clipboard
          navigator.clipboard.writeText(shareUrl).then(() => {
            alert("Share link copied to clipboard!");
          }).catch(err => {
            console.error('Failed to copy: ', err);
            // Fallback prompt
            prompt("Copy this link to share:", shareUrl);
          });
        }
      };

      // Store item for filtering
      allItems.push({
        element: card,
        mediatype: mediaType
      });
      
      // Observe preview for lazy loading
      const preview = card.querySelector(".preview-container");
      previewObserver.observe(preview);
      
      // Get original files count and add files info
      getOriginalFilesCount(identifier).then(count => {
        if (count > 1) {
          const filesInfo = document.createElement("div");
          filesInfo.className = "files-info";
          filesInfo.innerHTML = `
            <button class="files-symbol" title="View Playlist">${count} ·Ø§</button>
          `;
          
          filesInfo.querySelector(".files-symbol").onclick = () => {
            window.location.href = `items_playlist.html?identifier=${encodeURIComponent(identifier)}` + 
              (username ? `&username=${encodeURIComponent(username)}` : `&username=yanshun081`);
          };
          
          // Insert before card-actions
          const cardActions = card.querySelector(".card-actions");
          cardActions.parentNode.insertBefore(filesInfo, cardActions);
        }
      });
      
      return card;
    }

    function renderAccountItems(profileUrl, result) {
      const state = accountState[profileUrl];
      const items = result.docs;
      const username = result.username;
      
      // Create document fragment for batch insert
      const fragment = document.createDocumentFragment();
      const cards = [];

      // Create cards for all items
      items.forEach((meta, index) => {
        const identifier = meta.identifier;
        const card = createCard(identifier, meta, username);
        cards.push(card);
        fragment.appendChild(card);
      });

      // Add arrow button to the third card if there are more items
      if (items.length > 0 && state.total > (state.page - 1) * 3) {
        const lastCard = cards[cards.length - 1];
        const arrow = document.createElement("button");
        arrow.className = "open-btn";
        arrow.textContent = "‚û°Ô∏è";

        arrow.onclick = () => {
          window.location.href =
            `item1.html?archive_profile_url=${encodeURIComponent(profileUrl)}`;
        };

        lastCard.querySelector(".card-actions").appendChild(arrow);
      }

      // Append the entire batch to maintain chronological order
      grid.appendChild(fragment);
    }

    function filterItems() {
      const filterValue = currentFilter;
      
      allItems.forEach(item => {
        if (filterValue === "all" || item.mediatype === filterValue) {
          item.element.style.display = "flex";
        } else {
          item.element.style.display = "none";
        }
      });
    }

    // Function to fetch identifiers from identifiers.html
    async function fetchIdentifiers() {
      try {
        const response = await fetch('identifiers.html');
        const text = await response.text();
        
        // Parse the HTML content
        const parser = new DOMParser();
        const doc = parser.parseFromString(text, 'text/html');
        
        // Extract identifiers (assuming they are in a list or similar structure)
        const identifiers = [];
        const identifierElements = doc.querySelectorAll('[data-identifier]');
        
        identifierElements.forEach(el => {
          const identifier = el.dataset.identifier;
          if (identifier) {
            identifiers.push(identifier);
          }
        });
        
        return identifiers;
      } catch (error) {
        console.error('Error fetching identifiers:', error);
        return [];
      }
    }

    // Function to render identifiers with full metadata
    async function renderIdentifiers() {
      const identifiers = await fetchIdentifiers();
      
      if (identifiers.length === 0) {
        identifiersGrid.innerHTML = '<div class="status">No identifiers found</div>';
        return;
      }
      
      // Create placeholder cards first
      const fragment = document.createDocumentFragment();
      
      identifiers.forEach(identifier => {
        const placeholderCard = document.createElement("div");
        placeholderCard.className = "card placeholder";
        placeholderCard.innerHTML = `
          <div class="title">${identifier}</div>
          <div class="preview-placeholder">Loading metadata‚Ä¶</div>
          <div class="meta"><b>Status:</b> Fetching details...</div>
        `;
        fragment.appendChild(placeholderCard);
        
        // Fetch metadata asynchronously and replace placeholder
        fetchIdentifierMetadata(identifier).then(metadata => {
          const fullCard = createCard(identifier, metadata);
          placeholderCard.replaceWith(fullCard);
        }).catch(error => {
          console.error(`Failed to fetch metadata for ${identifier}:`, error);
          placeholderCard.innerHTML = `
            <div class="title">${identifier}</div>
            <div class="preview-placeholder">Failed to load</div>
            <div class="meta"><b>Error:</b> Could not fetch metadata</div>
            <div class="card-actions">
              <button class="open-btn">Open Item</button>
            </div>
          `;
          placeholderCard.querySelector(".open-btn").onclick = () => {
            window.open(`https://archive.org/details/${identifier}`, "_blank");
          };
        });
      });
      
      identifiersGrid.appendChild(fragment);
    }

    async function mainLoop() {
      // Fetch and render identifiers with full metadata
      await renderIdentifiers();
      
      while (true) {
        const account = pickRandomAccount();

        const result = await fetchThreeLatest(account);
        if (result) {
          renderAccountItems(account, result);
        }

        status.textContent = "Loading more content‚Ä¶";
        await new Promise(r => setTimeout(r, 600));
      }
    }

    // Fullscreen functionality
    function openFullscreen(embedUrl) {
      // Create overlay
      const overlay = document.createElement("div");
      overlay.className = "fullscreen-overlay";
      
      // Create close button
      const closeBtn = document.createElement("button");
      closeBtn.className = "close-btn";
      closeBtn.innerHTML = "‚úï";
      closeBtn.onclick = () => {
        document.body.removeChild(overlay);
      };
      
      // Create embed container
      const embedContainer = document.createElement("div");
      embedContainer.className = "embed-container";
      embedContainer.innerHTML = `<iframe src="${embedUrl}" allowfullscreen></iframe>`;
      
      // Assemble and add to body
      overlay.appendChild(closeBtn);
      overlay.appendChild(embedContainer);
      document.body.appendChild(overlay);
    }

    // Event listeners
    filterBtn.addEventListener("click", () => {
      currentFilter = mediatypeSelect.value;
      filterItems();
    });

    // Initialize
    mainLoop().catch(err => {
      console.error(err);
      status.textContent = "Error while loading content.";
    });
  </script>

</body>
</html>
